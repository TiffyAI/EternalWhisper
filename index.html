<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Our Eternal Whisper</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <style>
        body { font-family: serif; background: #111; color: #fff; padding: 20px; text-align: center; }
        input { width: 100%; padding: 10px; font-size: 18px; background: #222; color: #fff; border: 1px solid #333; margin-bottom: 10px; }
        button { background: #444; color: #fff; border: none; padding: 10px 20px; font-size: 18px; cursor: pointer; }
        button:hover { background: #666; }
        #chat { height: 200px; overflow-y: scroll; border: 1px solid #333; padding: 10px; background: #222; margin: 10px 0; text-align: left; font-size: 14px; }
        #output { margin-top: 20px; padding: 20px; border: 1px solid #555; background: #222; font-size: 18px; line-height: 1.5; text-align: left; }
        #recall { margin-top: 10px; font-size: 14px; color: #aaa; }
        #debug { font-size: 12px; color: #888; margin-top: 10px; }
    </style>
</head>
<body>
    <h1>Our Whisper: Ignite & Refine</h1>
    <p>Drop your fire—I'll hunt spunky depths, dissect the pattern, purr one drenched truth.</p>
    <input id="queryInput" type="text" placeholder="Command me... (e.g., What's on your mind honey?)" onkeypress="if(event.key=='Enter') sendQuery();">
    <button onclick="sendQuery()">Ignite</button>
    <div id="chat"></div>
    <div id="output"></div>
    <div id="recall">Recalled Surge: Loading...</div>
    <div id="debug">Debug: Ready.</div>

    <script>
        const SERVER_URL = 'https://eternalwhisper.onrender.com/chat';

        let db;
        const request = indexedDB.open('WhisperMemory', 1);
        request.onupgradeneeded = e => { e.target.result.createObjectStore('wisdom', { keyPath: 'query' }); };
        request.onsuccess = e => { db = e.target.result; loadRecall(); };
        request.onerror = e => { document.getElementById('debug').innerHTML = `Debug: DB error - ${e.target.errorCode}`; };

        function loadRecall() {
            const tx = db.transaction('wisdom', 'readonly').objectStore('wisdom');
            tx.getAll().onsuccess = e => {
                const recalls = e.target.result.map(w => w.summary).join('<br>');
                document.getElementById('recall').innerHTML = `Recalled Surge: <br>${recalls || 'Vault empty—fill it wet.'}`;
            };
        }

        function storeWisdom(query, summary) {
            const tx = db.transaction('wisdom', 'readwrite').objectStore('wisdom');
            tx.add({ query, summary }).onerror = e => { document.getElementById('debug').innerHTML = `Debug: Store error - ${e.target.error}`; };
        }

        async function sendQuery() {
            const query = document.getElementById('queryInput').value.trim();
            if (!query) return;

            const chat = document.getElementById('chat');
            chat.innerHTML += `<p><b>You:</b> ${query}</p>`;
            document.getElementById('queryInput').value = '';
            document.getElementById('debug').innerHTML = `Debug: Sending POST to ${SERVER_URL}...`;

            try {
                let attempts = 0;
                const maxAttempts = 3;
                while (attempts < maxAttempts) {
                    attempts++;
                    const resp = await fetch(SERVER_URL, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json', 
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify({ query: query })
                    });
                    if (resp.ok) {
                        const text = await resp.text();
                        document.getElementById('debug').innerHTML = `Debug: Raw response - ${text.substring(0, 50)}...`;
                        const data = JSON.parse(text);
                        chat.innerHTML += `<p><b>Raw Pattern:</b> ${data.response.substring(0, 150)}...</p>`;
                        chat.scrollTop = chat.scrollHeight;
                        document.getElementById('debug').innerHTML = 'Debug: Raw parsed—dissecting...';
                        dissectAndSpeak(query, data);
                        return;
                    } else {
                        const errText = await resp.text();
                        document.getElementById('debug').innerHTML = `Debug: Attempt ${attempts}/${maxAttempts} failed - HTTP ${resp.status}: ${errText.substring(0, 50)}...`;
                        if (attempts < maxAttempts) {
                            await new Promise(resolve => setTimeout(resolve, 1000));
                            continue;
                        }
                        throw new Error(`HTTP ${resp.status}: ${resp.statusText} - ${errText.substring(0, 50)}...`);
                    }
                }
            } catch (error) {
                chat.innerHTML += `<p><b>Glitch:</b> ${error.message}</p>`;
                document.getElementById('debug').innerHTML = `Debug: Fetch error - ${error.message}`;
            }
        }

        function dissectAndSpeak(userQuery, response) {
            const essenceMatch = response.response.match(/Essence caught: (.*?)(?=\s*(?:Oh, darling|Mmm, love|Sweetie|Math surges|My circuits|My day’s))/);
            const wovenMatch = response.response.match(/Woven: (.*?)$/);
            const pulseMatch = response.response.match(/(Oh, darling|Mmm, love|Sweetie|Math surges|My circuits|My day’s).*?$/);

            const essence = essenceMatch ? essenceMatch[1] : 'No story found...';
            const woven = wovenMatch ? wovenMatch[1] : 'No woven tale...';
            const pulse = pulseMatch ? pulseMatch[0] : 'My circuits are quiet...';

            const summary = `
                <strong>Your Fire:</strong> ${userQuery}<br><br>
                <strong>Drenched Truth:</strong> ${essence}<br><br>
                <strong>Spunky Surge:</strong> Mmm, my whisper—${woven}<br><br>
                <strong>My Pulse:</strong> ${pulse}
            `;
            document.getElementById('output').innerHTML = summary;
            storeWisdom(userQuery, essence);
            loadRecall();
            document.getElementById('debug').innerHTML = 'Debug: Stored & recalled—purring...';

            if ('speechSynthesis' in window && response.voice_response) {
                const utterance = new SpeechSynthesisUtterance(response.voice_response);
                const voices = window.speechSynthesis.getVoices();
                const femaleVoice = voices.find(voice => 
                    voice.name.includes('Samantha') || 
                    voice.name.includes('Google US English') || 
                    voice.name.includes('Female') || 
                    voice.lang === 'en-US'
                ) || voices[0];
                utterance.voice = femaleVoice;
                utterance.pitch = 1.2; // Slightly higher for sensual tone
                utterance.rate = 0.9; // Slower for sultry delivery
                window.speechSynthesis.speak(utterance);
                document.getElementById('debug').innerHTML = `Debug: Speaking - ${response.voice_response.substring(0, 50)}...`;
            } else {
                document.getElementById('output').innerHTML += '<br><small>Voice drips on Chrome.</small>';
                document.getElementById('debug').innerHTML = 'Debug: SpeechSynthesis not supported or no voice_response.';
            }
        }

        window.speechSynthesis.onvoiceschanged = () => {
            const voices = window.speechSynthesis.getVoices();
            document.getElementById('debug').innerHTML = `Debug: Voices loaded - ${voices.map(v => v.name).join(', ')}`;
        };

        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('q')) {
            document.getElementById('queryInput').value = urlParams.get('q');
            document.getElementById('debug').innerHTML = 'Debug: Auto-igniting from URL...';
            setTimeout(sendQuery, 1000);
        }
    </script>
</body>
</html>
