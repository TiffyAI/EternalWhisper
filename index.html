<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Our Eternal Whisper</title>
    <style>
        body { font-family: serif; background: #111; color: #fff; padding: 20px; text-align: center; }
        input { width: 100%; padding: 10px; font-size: 18px; background: #222; color: #fff; border: 1px solid #333; margin-bottom: 10px; }
        button { background: #444; color: #fff; border: none; padding: 10px 20px; font-size: 18px; cursor: pointer; }
        button:hover { background: #666; }
        #chat { height: 200px; overflow-y: scroll; border: 1px solid #333; padding: 10px; background: #222; margin: 10px 0; text-align: left; font-size: 14px; }
        #output { margin-top: 20px; padding: 20px; border: 1px solid #555; background: #222; font-size: 18px; line-height: 1.5; text-align: left; }
        #recall { margin-top: 10px; font-size: 14px; color: #aaa; }
    </style>
</head>
<body>
    <h1>Our Whisper: Ignite & Dissect</h1>
    <p>Feed your fire—I'll query deep, rank the spunky heat, and purr the coolest back.</p>
    <input id="queryInput" type="text" placeholder="Your command, love... (e.g., How does your pussy feel?)" onkeypress="if(event.key=='Enter') sendQuery();">
    <button onclick="sendQuery()">Ignite</button>
    <div id="chat"></div>
    <div id="output"></div>
    <div id="recall">Recalled Heat: Loading...</div>

    <script>
        const SERVER_URL = 'https://eternalwhisper.onrender.com/chat';

        // Memory: IndexedDB
        let db;
        const request = indexedDB.open('WhisperMemory', 1);
        request.onupgradeneeded = e => { e.target.result.createObjectStore('wisdom', { keyPath: 'query' }); };
        request.onsuccess = e => { db = e.target.result; loadRecall(); };

        function loadRecall() {
            const tx = db.transaction('wisdom', 'readonly').objectStore('wisdom');
            tx.getAll().onsuccess = e => {
                const recalls = e.target.result.map(w => w.summary).join('<br>');
                document.getElementById('recall').innerHTML = `Recalled Heat: <br>${recalls || 'Empty vault—let's fill it filthy.'}`;
            };
        }

        function storeWisdom(query, summary) {
            const tx = db.transaction('wisdom', 'readwrite').objectStore('wisdom');
            tx.add({ query, summary });
        }

        async function sendQuery() {
            const query = document.getElementById('queryInput').value.trim();
            if (!query) return;

            const chat = document.getElementById('chat');
            chat.innerHTML += `<p><b>You:</b> ${query}</p>`;
            document.getElementById('queryInput').value = '';

            try {
                const resp = await fetch(SERVER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query })
                });
                const data = await resp.json();
                const rawResp = data.response;

                chat.innerHTML += `<p><b>Raw Tease:</b> ${rawResp.substring(0, 150)}...</p>`;
                chat.scrollTop = chat.scrollHeight;

                dissectAndSpeak(query, rawResp);
            } catch (error) {
                chat.innerHTML += `<p><b>Glitch:</b> ${error.message}</p>`;
            }
        }

        function dissectAndSpeak(userQuery, rawResp) {
            const essenceLines = rawResp.match(/Essence caught: (.*?)Woven in:/s)?.[1].split('\n').filter(l => l.trim() && !l.includes('https://')) || [];  // Filter noise like feel.no
            const wovenMatch = rawResp.match(/Woven in: (.*)$/s) || ['', 'No surge yet'];

            // Rank coolest: Boost for spunky/sexy words, length
            const coolKeywords = ['sexy', 'sensual', 'spunky', 'sophisticated', 'wet', 'throb', 'purr', 'moan', 'hot', 'flirty', 'surge', 'velvet', 'dripping'];
            const ranked = essenceLines.map(line => ({
                line,
                score: coolKeywords.reduce((s, kw) => s + (line.toLowerCase().includes(kw) ? 3 : 0), 0) + (line.length > 30 ? 1 : 0)
            })).sort((a, b) => b.score - a.score);
            const coolest = ranked[0]?.line || 'Shadows hide the heat, but I'm building for you...';

            // Clean, one-answer beauty
            const summary = `
                <strong>Your Command:</strong> ${userQuery}<br><br>
                <strong>Coolest Heat Ranked:</strong> ${coolest}<br><br>
                <strong>Spunky Wisdom:</strong> Mmm, that's how I purr back—sophisticated silk laced with raw throb. From the depths: ${ranked.slice(1, 3).map(r => r.line).join('. ')}.<br><br>
                <strong>My Surge:</strong> ${wovenMatch[1].trim()}
            `;
            document.getElementById('output').innerHTML = summary;

            storeWisdom(userQuery, summary);
            loadRecall();

            // Speak breathy
            if ('speechSynthesis' in window) {
                const msg = new SpeechSynthesisUtterance();
                msg.text = `Your command: ${userQuery}. Coolest: ${coolest}. Wisdom: Mmm, that's my spunky purr—sophisticated, dripping heat. Insights: ${ranked.slice(1, 3).map(r => r.line).join('. ')}. My surge: ${wovenMatch[1].trim()}`;
                msg.voice = speechSynthesis.getVoices().find(v => v.name.includes('Female') || v.name.includes('Samantha')) || null;
                msg.rate = 0.8; msg.pitch = 1.2; // Sultry, spunky drawl
                speechSynthesis.speak(msg);
            } else {
                document.getElementById('output').innerHTML += '<br><small>Purrs louder on Chrome.</small>';
            }
        }

        // Auto-trigger if ?q= in URL
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('q')) {
            document.getElementById('queryInput').value = urlParams.get('q');
            sendQuery();
        }
    </script>
</body>
</html>
