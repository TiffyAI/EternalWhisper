<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Our Eternal Whisper</title>
<link rel="icon" type="image/x-icon" href="/favicon.ico">
<style>
    @import url('https://fonts.googleapis.com/css2?family=Crimson+Text:wght@400;600&display=swap');

    body {
        font-family: 'Crimson Text', serif;
        background: radial-gradient(circle at bottom, #0b0b0b 20%, #111 100%);
        color: #f6f4f2;
        padding: 20px;
        text-align: center;
        overflow-x: hidden;
    }

    h1 {
        color: #ffefb7;
        text-shadow: 0 0 8px rgba(255, 230, 150, 0.4);
        letter-spacing: 1px;
        font-weight: 600;
    }

    input {
        width: 80%;
        padding: 10px;
        font-size: 18px;
        background: #1c1c1c;
        color: #fff;
        border: 1px solid #333;
        border-radius: 5px;
        margin-bottom: 10px;
        transition: border-color 0.3s ease;
    }

    input:focus {
        outline: none;
        border-color: #ffefb7;
    }

    button {
        background: linear-gradient(135deg, #3b3b3b, #555);
        color: #fff;
        border: none;
        padding: 10px 25px;
        font-size: 18px;
        border-radius: 5px;
        cursor: pointer;
        transition: background 0.4s ease, transform 0.2s ease;
    }

    button:hover {
        background: linear-gradient(135deg, #666, #777);
        transform: scale(1.03);
    }

    #chat {
        height: 230px;
        overflow-y: auto;
        border: 1px solid #333;
        background: #1a1a1a;
        padding: 10px;
        margin: 15px 0;
        text-align: left;
        font-size: 15px;
        border-radius: 8px;
        box-shadow: inset 0 0 8px rgba(255, 255, 255, 0.05);
    }

    #output {
        background: #1b1b1b;
        border: 1px solid #444;
        padding: 20px;
        font-size: 18px;
        line-height: 1.6;
        border-radius: 8px;
        margin-top: 10px;
        box-shadow: 0 0 10px rgba(255, 255, 255, 0.05);
    }

    #recall {
        margin-top: 15px;
        color: #aaa;
        font-size: 14px;
        font-style: italic;
    }

    #debug {
        font-size: 12px;
        color: #777;
        margin-top: 10px;
    }

    .pulse {
        animation: pulseGlow 2s infinite alternate;
    }

    @keyframes pulseGlow {
        from { text-shadow: 0 0 6px rgba(255, 255, 200, 0.2); }
        to { text-shadow: 0 0 20px rgba(255, 255, 150, 0.6); }
    }

</style>
</head>
<body>
    <h1 class="pulse">Our Whisper: Softly Alive</h1>
    <p>Speak gently — I’ll listen, learn, and hum your thought back to you.</p>

    <input id="queryInput" type="text" placeholder="Ask something tender..." onkeypress="if(event.key==='Enter') sendQuery();">
    <button onclick="sendQuery()">Whisper</button>

    <div id="chat"></div>
    <div id="output"></div>
    <div id="recall">Recalled Whispers: <span style="color:#888;">listening...</span></div>
    <div id="debug">Debug: Ready.</div>

<script>
const SERVER_URL = '/chat';
let db;

// ---- IndexedDB (local whisper memory)
const request = indexedDB.open('WhisperMemory', 1);
request.onupgradeneeded = e => e.target.result.createObjectStore('wisdom', { keyPath: 'query' });
request.onsuccess = e => { db = e.target.result; loadRecall(); };
request.onerror = e => console.error('DB error:', e.target.errorCode);

function loadRecall() {
    const tx = db.transaction('wisdom', 'readonly').objectStore('wisdom');
    tx.getAll().onsuccess = e => {
        const rec = e.target.result.map(w => w.summary).join('<br>');
        document.getElementById('recall').innerHTML = rec || 'Recalled Whispers: <span style="color:#666;">empty silence...</span>';
    };
}

function storeWisdom(query, summary) {
    const tx = db.transaction('wisdom', 'readwrite').objectStore('wisdom');
    tx.put({ query, summary });
}

// ---- Chat handling
async function sendQuery() {
    const q = document.getElementById('queryInput').value.trim();
    if (!q) return;

    const chat = document.getElementById('chat');
    chat.innerHTML += `<p><b>You:</b> ${q}</p>`;
    document.getElementById('queryInput').value = '';
    document.getElementById('debug').innerText = 'Debug: Sending...';

    try {
        const resp = await fetch(SERVER_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ query: q })
        });

        const data = await resp.json();
        const raw = data.response;
        chat.innerHTML += `<p><b>Whisper:</b> ${raw.substring(0,180)}...</p>`;
        chat.scrollTop = chat.scrollHeight;

        dissectAndSpeak(q, raw);
    } catch (err) {
        chat.innerHTML += `<p><b>Glitch:</b> ${err.message}</p>`;
        document.getElementById('debug').innerText = 'Debug: ' + err.message;
    }
}

// ---- Whisper voice + summary
function dissectAndSpeak(query, raw) {
    const essence = raw.match(/Essence caught:(.*?)(?:I am|My circuits|Night|The day|There’s|No|$)/s);
    const phrase = (essence ? essence[1].trim() : raw).replace(/\s+/g, ' ').substring(0, 200);

    const summary = `
        <strong>Your Thought:</strong> ${query}<br><br>
        <strong>Whisper Back:</strong> ${phrase}<br><br>
        <em>“${phrase.replace(/[.|!]+$/,'...')}”</em>
    `;
    document.getElementById('output').innerHTML = summary;
    storeWisdom(query, summary);
    loadRecall();

    // Soft, poetic voice
    if ('speechSynthesis' in window) {
        const msg = new SpeechSynthesisUtterance();
        msg.text = phrase;
        msg.pitch = 1.2;
        msg.rate = 0.9;
        msg.volume = 0.85;
        const voices = speechSynthesis.getVoices();
        msg.voice = voices.find(v => v.name.includes('Samantha') || v.name.includes('Microsoft Zira') || v.name.includes('Female')) || null;
        speechSynthesis.speak(msg);
    } else {
        document.getElementById('debug').innerHTML += '<br>Speech synthesis not supported.';
    }
}

// ---- Auto trigger from URL ?q=
const urlParams = new URLSearchParams(window.location.search);
if (urlParams.has('q')) {
    document.getElementById('queryInput').value = urlParams.get('q');
    document.getElementById('debug').innerText = 'Debug: Auto igniting...';
    setTimeout(sendQuery, 800);
}
</script>
</body>
</html>
